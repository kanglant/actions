# Copyright 2026 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Bazel Workload Executor
description: "Executes a benchmark defined by a Bazel target."

inputs:
  target:
    description: "The Bazel target to run (e.g. //benchmarks:my_test)."
    required: true
  bazel_run_flags:
    description: "Base flags to pass to the bazel run command."
    required: false
    default: ""
  bazel_run_flags_hw:
    description: "Hardware-specific bazel run flags, appended to bazel_run_flags."
    required: false
    default: ""
  runtime_flags:
    description: "Base runtime flags passed to the binary."
    required: false
    default: ""
  runtime_flags_hw:
    description: "Hardware-specific runtime flags, appended to runtime_flags."
    required: false
    default: ""

runs:
  using: "composite"
  steps:
    - name: Run Bazel target
      shell: bash
      working-directory: user_repo
      env:
        TARGET: ${{ inputs.target }}
        BAZEL_RUN_FLAGS: "${{ inputs.bazel_run_flags }} ${{ inputs.bazel_run_flags_hw }}"
        ARGS: "${{ inputs.runtime_flags }} ${{ inputs.runtime_flags_hw }}"
      run: |
        echo "::group::Run Bazel target"
        set -euo pipefail

        echo "----------------------------------------------------------------"
        echo "TARGET: $TARGET"
        echo "BAZEL RUN FLAGS: $BAZEL_RUN_FLAGS"
        echo "ARGS: $ARGS"
        echo "----------------------------------------------------------------"

        bazel run \
          --noshow_progress \
          --noshow_loading_progress \
          --ui_event_filters=-info \
          $BAZEL_RUN_FLAGS \
          "$TARGET" \
          -- \
          $ARGS

        echo "::endgroup::"
