# Reusable workflow to run benchmarks defined in a benchmark registry.
#
# This workflow generates and executes a parallel matrix of benchmark jobs
# based on the provided registry_file and workflow_type.
#
# Note that GITHUB_WORKSPACE env var is used instead of github.workspace
# context reference due to https://github.com/actions/runner/issues/2058. 
# Specifically, github.workspace and runner.workspace don't point to container 
# valid paths when executing inside a container job.
name: Run benchmarks

on:
  workflow_call:
    inputs:
      registry_file:
        description: "Path to the .pbtxt benchmark registry file, relative to the repository root."
        required: true
        type: string
      workflow_type:
        description: "The workflow type to run (e.g., PRESUBMIT)."
        required: true
        type: string
      ml_actions_ref:
        description: >
          The branch, tag, or SHA of google-ml-infra/actions to use. Defaults to 'main'.
          Note: For runs triggered from within the google-ml-infra/actions repo
          (e.g., a PR), the commit SHA (github.sha) is used automatically to test changes.
        required: false
        type: string
        default: 'main'

permissions:
  contents: read # Required for actions/checkout.

jobs:
  generate_matrix:
    name: Generate matrix
    runs-on: linux-x86-n2-16
    container:
      image: us-docker.pkg.dev/ml-oss-artifacts-published/ml-public-container/ml-build:latest@sha256:f3b96c5ae6ad8e1354693a45f920ea19f28f6bc5d8c5896de20832569c715d00 # ratchet:us-docker.pkg.dev/ml-oss-artifacts-published/ml-public-container/ml-build:latest
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}
    steps:
      - name: Check out user repo
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # ratchet:actions/checkout@v5
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.sha }}
          path: user_repo
          persist-credentials: false

      - name: Extract ML actions repo ref
        env:
          USER_REPO: ${{ github.repository }}
          USER_REPO_SHA: ${{ github.sha }}
          ML_ACTIONS_REF_INPUT: ${{ inputs.ml_actions_ref }}
          ML_ACTIONS_REPO: google-ml-infra/actions
        id: extract_ml_actions_repo_ref
        shell: bash
        run: |
          set -euo pipefail
          REPO_REF=""

          if [[ "$USER_REPO" == "$ML_ACTIONS_REPO" ]]; then
            # Use SHA for ML Actions PRs for reproducibility.
            REPO_REF="$USER_REPO_SHA"
          else
            # For external repos, use provided ref.
            REPO_REF="$ML_ACTIONS_REF_INPUT"
          fi

          echo "repo_ref=$REPO_REF" >> "$GITHUB_OUTPUT"

      - name: Check out ML actions repo
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # ratchet:actions/checkout@v5
        with:
          repository: 'google-ml-infra/actions'
          ref: ${{ steps.extract_ml_actions_repo_ref.outputs.repo_ref}}
          path: ml_actions
          persist-credentials: false

      - name: Generate benchmark matrix
        env: 
          REGISTRY_FILE: ${{ inputs.registry_file }}
          WORKFLOW_TYPE: ${{ inputs.workflow_type }}
        id: generate
        shell: bash
        run: |
          set -euo pipefail
          ML_ACTIONS_REPO="$GITHUB_WORKSPACE/ml_actions"
          REGISTRY_PATH="$GITHUB_WORKSPACE/user_repo/$REGISTRY_FILE"
          MATRIX_JSON_PATH="$GITHUB_WORKSPACE/matrix.json"
          cd "$ML_ACTIONS_REPO" || exit 1

          MATRIX_JSON="$(bazel run //benchmarking/gh_matrix_generator -- \
          --registry_file="$REGISTRY_PATH" \
          --workflow_type="$WORKFLOW_TYPE" | jq -c '.')"

          echo "$MATRIX_JSON" | jq '.' > "$MATRIX_JSON_PATH"
          echo "matrix_json_path=$MATRIX_JSON_PATH" >> "$GITHUB_OUTPUT"
          echo "matrix=$MATRIX_JSON" >> "$GITHUB_OUTPUT"

      - name: Upload matrix JSON artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # ratchet:actions/upload-artifact@v4
        with:
          name: matrix-json
          path: ${{ steps.generate.outputs.matrix_json_path }}

  run_benchmarks:
    name: Run benchmark (${{ matrix.config_id }})
    needs: generate_matrix
    if: needs.generate_matrix.outputs.matrix != '[]'
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate_matrix.outputs.matrix) }}

    runs-on: ${{ matrix.runner_label }}
    container:
      image: ${{ matrix.container_image }}

    steps:
      - name: Check out user repo
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # ratchet:actions/checkout@v5
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.sha }}
          path: user_repo
          persist-credentials: false

      - name: Extract ML actions repo ref
        env:
          USER_REPO: ${{ github.repository }}
          USER_REPO_SHA: ${{ github.sha }}
          ML_ACTIONS_REF_INPUT: ${{ inputs.ml_actions_ref }}
          ML_ACTIONS_REPO: google-ml-infra/actions
        id: extract_ml_actions_repo_ref
        shell: bash
        run: |
          set -euo pipefail
          REPO_REF=""

          if [[ "$USER_REPO" == "$ML_ACTIONS_REPO" ]]; then
            # Use SHA for ML Actions PRs for reproducibility.
            REPO_REF="$USER_REPO_SHA"
          else
            # For external repos, use provided ref.
            REPO_REF="$ML_ACTIONS_REF_INPUT"
          fi

          echo "repo_ref=$REPO_REF" >> "$GITHUB_OUTPUT"

      - name: Check out ML actions repo
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # ratchet:actions/checkout@v5
        with:
          repository: 'google-ml-infra/actions'
          ref: ${{ steps.extract_ml_actions_repo_ref.outputs.repo_ref}}
          path: ml_actions
          persist-credentials: false

      - name: Set up Python
        if: matrix.workload_type == 'python_workload'
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # ratchet:actions/setup-python@v5
        with:
          python-version: ${{ matrix.workload_details.pythonVersion }}

      - name: Install Python deps
        if: matrix.workload_type == 'python_workload'
        env:
          PIP_PROJECT_PATH: ${{ matrix.workload_details.pipProjectPath || '.' }}
          PIP_EXTRA_DEPS_JSON: ${{ toJson(matrix.pip_extra_deps) }}
        shell: bash
        run: |
          ML_ACTIONS_REPO="$GITHUB_WORKSPACE/ml_actions"
          "$ML_ACTIONS_REPO"/benchmarking/install_pip_deps.sh

      - name: Run benchmark
        env: 
          WORKLOAD_TYPE: ${{ matrix.workload_type }}
          EXECUTION_TARGET: ${{ matrix.workload_details.executionTarget }}
          SCRIPT_PATH: ${{ matrix.workload_details.scriptPath }}
          RUNTIME_FLAGS_JSON: ${{ toJson(matrix.runtime_flags) }}
        shell: bash
        run: |
          ML_ACTIONS_REPO="$GITHUB_WORKSPACE/ml_actions"
          "$ML_ACTIONS_REPO"/benchmarking/run_benchmark.sh

      - name: Parse TensorBoard logs and create benchmark result artifact
        env:
          BENCHMARK_CONFIG_ID: ${{ matrix.config_id }}
          METRICS_MANIFEST_JSON: '${{ toJson(matrix.metrics) }}'
        id: parse_tb_logs
        shell: bash
        run: |
          set -euo pipefail
          TENSORBOARD_OUTPUT_DIR="$GITHUB_WORKSPACE/tblogs"
          ML_ACTIONS_REPO="$GITHUB_WORKSPACE/ml_actions"
          BENCHMARK_OUTPUT_DIR="$GITHUB_WORKSPACE/results"
          ARTIFACT_FILE_PATH="$BENCHMARK_OUTPUT_DIR/benchmark_result.json"
          mkdir -p "$BENCHMARK_OUTPUT_DIR"
          cd "$ML_ACTIONS_REPO" || exit 1

          bazel run //benchmarking/tb_parser -- \
            --metrics_manifest_json="$METRICS_MANIFEST_JSON" \
            --tblog_dir="$TENSORBOARD_OUTPUT_DIR" \
            --output_dir="$BENCHMARK_OUTPUT_DIR" \
            --config_id="$BENCHMARK_CONFIG_ID" \
            --commit_sha="$GITHUB_SHA" \
            --github_run_id="$GITHUB_RUN_ID"

          echo "artifact_path=$ARTIFACT_FILE_PATH" >> "$GITHUB_OUTPUT"

      - name: Upload benchmark artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # ratchet:actions/upload-artifact@v4
        with:
          name: benchmark-result-${{ matrix.config_id }}
          path: ${{ steps.parse_tb_logs.outputs.artifact_path }}

      - name: Run static threshold analyzer
        env:
          BENCHMARK_RESULT_FILE: ${{ steps.parse_tb_logs.outputs.artifact_path }}
          METRICS_MANIFEST_JSON: '${{ toJson(matrix.metrics) }}'
        id: static_threshold_analyzer
        shell: bash
        run: |
          set -euo pipefail
          ML_ACTIONS_REPO="$GITHUB_WORKSPACE/ml_actions"
          cd "$ML_ACTIONS_REPO" || exit 1

          bazel run //benchmarking/static_threshold_analyzer -- \
            --metrics_manifest_json="$METRICS_MANIFEST_JSON" \
            --benchmark_result_file="$BENCHMARK_RESULT_FILE"
