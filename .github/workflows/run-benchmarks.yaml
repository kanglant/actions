# Copyright 2026 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law of a greedor agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Reusable workflow to run benchmarks defined in a benchmark registry.
#
# This workflow generates and executes a parallel matrix of benchmark jobs
# based on the provided registry_file and workflow_type.
#
# Note that GITHUB_WORKSPACE env var is used instead of github.workspace
# context reference due to https://github.com/actions/runner/issues/2058. 
# Specifically, github.workspace and runner.workspace don't point to container 
# valid paths when executing inside a container job.
name: Run benchmarks

on:
  workflow_call:
    inputs:
      registry_file:
        description: "Path to the .pbtxt benchmark registry file, relative to the repository root."
        required: true
        type: string
      workflow_type:
        description: "The workflow type to run (e.g., PRESUBMIT)."
        required: true
        type: string
      ml_actions_ref:
        description: >
          The branch, tag, or SHA of google-ml-infra/actions to use. Defaults to 'main'.
          Note: For runs triggered from within the google-ml-infra/actions repo
          (e.g., a PR), the commit SHA (github.sha) is used automatically to test changes.
        required: false
        type: string
        default: 'main'
      publish_metrics:
        description: "If true, publishes benchmark results to Google Cloud Pub/Sub."
        required: false
        type: boolean
        default: false
      pub_sub_gcp_project_id:
        description: "Google Cloud Project ID for Pub/Sub."
        required: false
        type: string
        default: "ml-oss-benchmarking-production"
      pub_sub_gcp_topic_id:
        description: "Pub/Sub Topic ID to publish results to."
        required: false
        type: string
        default: "public-results-prod"

permissions:
  contents: read # Required for actions/checkout.

jobs:
  generate_matrix:
    name: Generate matrix
    runs-on: linux-x86-n2-16
    container:
      image: us-docker.pkg.dev/ml-oss-artifacts-published/ml-public-container/ml-build:latest@sha256:fa95dacafd53199ab68e3c28c488c0cc0d5fad3a4b0ac20af27f2bd0a061a55d # ratchet:us-docker.pkg.dev/ml-oss-artifacts-published/ml-public-container/ml-build:latest
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}
    steps:
      - name: Check out user repo
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # ratchet:actions/checkout@v5
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.sha }}
          path: user_repo
          persist-credentials: false

      - name: Extract ML actions repo ref
        env:
          USER_REPO: ${{ github.repository }}
          USER_REPO_SHA: ${{ github.sha }}
          ML_ACTIONS_REF_INPUT: ${{ inputs.ml_actions_ref }}
          ML_ACTIONS_REPO: google-ml-infra/actions
        id: extract_ml_actions_repo_ref
        shell: bash
        run: |
          set -euo pipefail
          REPO_REF=""

          if [[ "$USER_REPO" == "$ML_ACTIONS_REPO" ]]; then
            # Use SHA for ML Actions PRs for reproducibility.
            REPO_REF="$USER_REPO_SHA"
          else
            # For external repos, use provided ref.
            REPO_REF="$ML_ACTIONS_REF_INPUT"
          fi

          echo "repo_ref=$REPO_REF" >> "$GITHUB_OUTPUT"

      - name: Check out ML actions repo
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # ratchet:actions/checkout@v5
        with:
          repository: 'google-ml-infra/actions'
          ref: ${{ steps.extract_ml_actions_repo_ref.outputs.repo_ref}}
          path: ml_actions
          persist-credentials: false

      - name: Generate benchmark matrix
        env:
          REGISTRY_FILE: ${{ inputs.registry_file }}
          WORKFLOW_TYPE: ${{ inputs.workflow_type }}
        id: generate
        shell: bash
        run: |
          set -euo pipefail
          ML_ACTIONS_REPO="$GITHUB_WORKSPACE/ml_actions"
          REGISTRY_PATH="$GITHUB_WORKSPACE/user_repo/$REGISTRY_FILE"
          MATRIX_JSON_PATH="$GITHUB_WORKSPACE/matrix.json"
          cd "$ML_ACTIONS_REPO" || exit 1

          MATRIX_JSON="$(bazel run //benchmarking/gh_matrix_generator -- \
          --registry_file="$REGISTRY_PATH" \
          --workflow_type="$WORKFLOW_TYPE" | jq -c '.')"

          echo "$MATRIX_JSON" | jq '.' > "$MATRIX_JSON_PATH"
          echo "matrix_json_path=$MATRIX_JSON_PATH" >> "$GITHUB_OUTPUT"
          echo "matrix=$MATRIX_JSON" >> "$GITHUB_OUTPUT"

      - name: Upload matrix JSON artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # ratchet:actions/upload-artifact@v4
        with:
          name: matrix-json
          path: ${{ steps.generate.outputs.matrix_json_path }}

  run_benchmarks:
    name: Run benchmark (${{ matrix.config_id }})
    needs: generate_matrix
    if: needs.generate_matrix.outputs.matrix != '[]'
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate_matrix.outputs.matrix) }}

    runs-on: ${{ matrix.runner_label }}
    container:
      image: ${{ matrix.container_image }}

    steps:
      - name: Check out user repo
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # ratchet:actions/checkout@v5
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.sha }}
          path: user_repo
          persist-credentials: false

      - name: Extract ML actions repo ref
        env:
          USER_REPO: ${{ github.repository }}
          USER_REPO_SHA: ${{ github.sha }}
          ML_ACTIONS_REF_INPUT: ${{ inputs.ml_actions_ref }}
          ML_ACTIONS_REPO: google-ml-infra/actions
        id: extract_ml_actions_repo_ref
        shell: bash
        run: |
          set -euo pipefail
          REPO_REF=""

          if [[ "$USER_REPO" == "$ML_ACTIONS_REPO" ]]; then
            # Use SHA for ML Actions PRs for reproducibility.
            REPO_REF="$USER_REPO_SHA"
          else
            # For external repos, use provided ref.
            REPO_REF="$ML_ACTIONS_REF_INPUT"
          fi

          echo "repo_ref=$REPO_REF" >> "$GITHUB_OUTPUT"

      - name: Check out ML actions repo
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # ratchet:actions/checkout@v5
        with:
          repository: 'google-ml-infra/actions'
          ref: ${{ steps.extract_ml_actions_repo_ref.outputs.repo_ref}}
          path: ml_actions
          persist-credentials: false

      - name: Setup benchmark environment
        shell: bash
        run: |
          # Create TensorBoard output dir and export path to GITHUB_ENV
          TENSORBOARD_OUTPUT_DIR="$GITHUB_WORKSPACE/tblogs"
          mkdir -p "$TENSORBOARD_OUTPUT_DIR"

          echo "Created TensorBoard output dir at: $TENSORBOARD_OUTPUT_DIR"
          echo "TENSORBOARD_OUTPUT_DIR=$TENSORBOARD_OUTPUT_DIR" >> "$GITHUB_ENV"

      - name: Execute workload
        uses: ./ml_actions/benchmarking/actions/dynamic_action_executor
        with:
          action: ${{ matrix.workload.action }}
          action_inputs: ${{ matrix.workload.action_inputs && toJson(matrix.workload.action_inputs) || '{}' }}

      - name: Parse TensorBoard logs and create benchmark result artifact
        env:
          BENCHMARK_CONFIG_ID: ${{ matrix.config_id }}
          METRIC_SPECS_JSON: '${{ toJson(matrix.metrics) }}'
          WORKFLOW_TYPE: ${{ matrix.workflow_type }}
          RUNNER_LABEL: ${{ matrix.runner_label }}
          BRANCH: ${{ github.ref_name }}
          RUN_URL: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        id: parse_tb_logs
        shell: bash
        run: |
          set -euo pipefail
          ML_ACTIONS_REPO="$GITHUB_WORKSPACE/ml_actions"
          BENCHMARK_RESULTS_DIR="$GITHUB_WORKSPACE/results"
          BENCHMARK_RESULT_FILE="$BENCHMARK_RESULTS_DIR/benchmark_result.json"
          mkdir -p "$BENCHMARK_RESULTS_DIR"
          cd "$ML_ACTIONS_REPO" || exit 1

          bazel run //benchmarking/tb_parser -- \
            --metric_specs_json="$METRIC_SPECS_JSON" \
            --tblog_dir="$TENSORBOARD_OUTPUT_DIR" \
            --output_dir="$BENCHMARK_RESULTS_DIR" \
            --config_id="$BENCHMARK_CONFIG_ID" \
            --commit_sha="$GITHUB_SHA" \
            --github_run_id="$GITHUB_RUN_ID" \
            --workflow_type="$WORKFLOW_TYPE" \
            --runner_label="$RUNNER_LABEL" \
            --branch="$BRANCH" \
            --run_url="$RUN_URL"

          echo "benchmark_result_file=$BENCHMARK_RESULT_FILE" >> "$GITHUB_OUTPUT"
          echo "benchmark_results_dir=$BENCHMARK_RESULTS_DIR" >> "$GITHUB_OUTPUT"

      - name: Upload benchmark result
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # ratchet:actions/upload-artifact@v4
        with:
          name: benchmark-result-${{ matrix.config_id }}
          path: ${{ steps.parse_tb_logs.outputs.benchmark_result_file }}

      - name: Run static threshold analyzer
        env:
          METRIC_SPECS_JSON: '${{ toJson(matrix.metrics) }}'
          BENCHMARK_RESULT_FILE: ${{ steps.parse_tb_logs.outputs.benchmark_result_file }}
        id: static_threshold_analyzer
        shell: bash
        run: |
          set -euo pipefail
          ML_ACTIONS_REPO="$GITHUB_WORKSPACE/ml_actions"
          cd "$ML_ACTIONS_REPO" || exit 1

          bazel run //benchmarking/static_threshold_analyzer -- \
            --metric_specs_json="$METRIC_SPECS_JSON" \
            --benchmark_result_file="$BENCHMARK_RESULT_FILE"

      - name: Publish Results to Pub/Sub
        if: success() && inputs.publish_metrics
        env:
          PROJECT_ID: ${{ inputs.pub_sub_gcp_project_id }}
          TOPIC_ID: ${{ inputs.pub_sub_gcp_topic_id }}
          BENCHMARK_RESULTS_DIR: ${{ steps.parse_tb_logs.outputs.benchmark_results_dir }}
          USER_REPO: ${{ github.repository }}
        shell: bash
        run: |
          set -euo pipefail
          ML_ACTIONS_REPO="$GITHUB_WORKSPACE/ml_actions"
          cd "$ML_ACTIONS_REPO" || exit 1

          bazel run \
            --noshow_progress \
            //benchmarking/publisher:publish_results -- \
            --project_id="$PROJECT_ID" \
            --topic_id="$TOPIC_ID" \
            --benchmark_results_dir="$BENCHMARK_RESULTS_DIR" \
            --repo_name="$USER_REPO"
