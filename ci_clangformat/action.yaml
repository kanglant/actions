# Copyright 2025 Google LLC

# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at

#     https://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
name: "Check clang-format"
description: 'Action to run clang-format on changed files'
inputs:
  clang_format_version:
    description: 'The clang-format version to use.'
    required: true
    default: "20.1.5"
  filepaths:
    description: 'Optional space or comma separated list of file paths to check. If not provided, all changed .cc and .h files will be checked.'
    required: false
    default: "*.h *.cc"

runs:
  using: "composite"
  steps:
  - name: "Checking out repository"
    uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
    with:
      fetch-depth: 2
      persist-credentials: false
  - name: Run clang-format check
    id: check-format
    shell: bash
    env:
      REPO_CLANG_FORMAT: .clang-format
      ACTION_DEFAULT_CLANG_FORMAT: ${{ github.action_path }}.clang-format.default
      CLANG_FORMAT_VERSION: ${{ inputs.clang_format_version }}
      # Use base_ref for PRs, or the 'before' SHA for pushes
      TARGET_BRANCH: ${{ github.base_ref || github.event.before }}
      FILE_PATHS: ${{ inputs.filepaths }}
    run: |
      FILE_PATTERNS=$(echo "$FILE_PATHS" | tr ',' ' ')

      CLANG_FORMAT_COMMON_ARGS="--dry-run --Werror --verbose"

      # Add this line to resolve the dubious ownership error
      git config --global --add safe.directory "$GITHUB_WORKSPACE"

      # Determine the correct base for the git diff
      if [[ "${{ github.event_name }}" == "pull_request" ]]; then
        # For PRs, compare against the origin's base branch
        DIFF_BASE="origin/$TARGET_BRANCH"
        # Fetch the base branch to ensure it's available for comparison
        git fetch origin "$TARGET_BRANCH"
      elif [[ "${{ github.event_name }}" == "push" ]]; then
        if [[ "$TARGET_BRANCH" == "0000000000000000000000000000000000000000" || -z "$TARGET_BRANCH" ]]; then
          # Fallback for new branches or missing 'before' SHA
          DIFF_BASE="HEAD~1"
        else
          # For pushes, compare against the previous commit SHA
          DIFF_BASE="$TARGET_BRANCH"
        fi
      else
        echo "::error::Unsupported event type: ${GITHUB_EVENT_NAME}"
        exit 1
      fi

      echo "Comparing changes from $DIFF_BASE to HEAD"

      # Compare PR head against the base branch to find changed files.
      GIT_DIFF_CMD="git diff -z --name-only --diff-filter=d $DIFF_BASE HEAD -- $FILE_PATTERNS"

      if [ -f "$REPO_CLANG_FORMAT" ]; then
        echo "::notice::Using repository's .clang-format file."
        # uvx (an alias for `uv tool run`) installs and runs clang-format with a specific version.
        $GIT_DIFF_CMD | xargs -0 uvx clang-format==$CLANG_FORMAT_VERSION $CLANG_FORMAT_COMMON_ARGS
      else
        echo "::notice::Repository does not have a .clang-format file. Using the action's default under $ACTION_DEFAULT_CLANG_FORMAT."
        $GIT_DIFF_CMD | xargs -0 uvx clang-format==$CLANG_FORMAT_VERSION -style=file:$ACTION_DEFAULT_CLANG_FORMAT $CLANG_FORMAT_COMMON_ARGS
      fi
